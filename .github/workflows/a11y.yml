name: Accessibility (pa11y-ci)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  pa11y:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      # Run pa11y BUT don't stop the workflow here
      - name: Run pa11y-ci (capture exit code)
        id: pa11y
        run: |
          mkdir -p pa11y/html
          set +e
          npm run test:a11y
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          set -e
          # Always exit 0 so next steps run (artifact upload)
          exit 0

      # Debug: show what actually got generated (super useful)
      - name: List report files
        if: always()
        run: |
          echo "=== pa11y directory ==="
          ls -R pa11y || true

      - name: Upload pa11y report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: pa11y/

      # Fail the job AFTER uploading artifacts
      - name: Fail if pa11y failed
        if: always()
        run: |
          code="${{ steps.pa11y.outputs.exit_code }}"
          echo "Pa11y exit code: $code"
          if [ "$code" != "0" ]; then
            exit 1
          fi
